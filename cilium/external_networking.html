<!--
title: External_networking
description: 
published: true
date: 2025-12-28T09:18:38.908Z
tags: 
editor: ckeditor
dateCreated: 2025-12-27T20:31:47.506Z
-->

<h1>Egress Gateway</h1>
<ul>
  <li>Allow which node will all the traffic go out form? Egress Gateway (one or more node)</li>
  <li>Packets sent to the egress gateway from other nodes via VXLAN</li>
  <li>The IP that will be used in the egress request can be specified</li>
  <li>bpf.masquerade: true, kubeProxyReplacement: true, egressGateway.enabled: true</li>
</ul>
<h4>Egress Gateway Policy</h4>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2
kind: CiliumEgressGatewayPolicy
metadata:
 name: test
spec:
 selectors:
 - podSelector:
     matchLabels:
       app: test
 destinationCIDRs:
  - "traffic is going to this cidr"
 egressGateway:
  nodeSelector:
    matchLabels:
      node.kubernetes.io/name: testnode
  egressIP: theh SNAT IP will be used</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">cilium-dbg bpf egress list</code></pre>
<h1>LoadBalancer IPAM</h1>
<ul>
  <li>&nbsp;Cilium can provide external IPs to the loadbalancer svc</li>
</ul>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: "test"
spec:
  blocks:
    - cidr: ""
    - cidr: ""
    - start: 
      stop:
  serviceSelector:
    matchLabels:
     svc: test</code></pre>
<h3>BGP advertising&nbsp;</h3>
<ul>
  <li>&nbsp;bgpControlPlane.enalbed: true</li>
  <li>Label the nodes, and get the loopback IP address for BGP <span style="font-family:Arial, Helvetica, sans-serif;">adjacency, and the AS number.</span></li>
</ul>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2
kind: CiliumBGPClusterConfig
metadata:
  name: cilium-bgp
spec:
  nodeSelector:
    matchLabels:
      rack: rack0
  bgpInstances:
  - name: "instance-65000"
    localASN: 65000
    localPort: 179
    peers:
    - name: "peer-65000-tor1"
      peerASN: 65000
      peerAddress: fd00:10:0:0::1
      peerConfigRef:
        name: "cilium-peer"
    - name: "peer-65000-tor2"
      peerASN: 65000
      peerAddress: fd00:11:0:0::1
      peerConfigRef:
        name: "cilium-peer"
</code></pre>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2
kind: CiliumBGPPeerConfig
metadata:
  name: cilium-peer
spec:
  timers:
    holdTimeSeconds: 9
    keepAliveTimeSeconds: 3
  authSecretRef: bgp-auth-secret
  ebgpMultihop: 4
  gracefulRestart:
    enabled: true
    restartTimeSeconds: 15
  families:
    - afi: ipv4
      safi: unicast
      advertisements:
        matchLabels:
          advertise: "bgp"
</code></pre>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2
kind: CiliumBGPAdvertisement
metadata:
  name: bgp-advertisements
  labels:
    advertise: bgp
spec:
  advertisements:
    - advertisementType: "PodCIDR"
      attributes:
        communities:
          standard: [ "65000:99" ]
        localPreference: 99
</code></pre>
<pre><code class="language-plaintext">cilium bgp peers
cilium bgp routes -h</code></pre>
<h4>L2 announcements&nbsp;</h4>
<ul>
  <li>Utilize ARP response to advertise the services IPs by the nodes of the cluster</li>
  <li>kubeProxyRelacement: true, l2announcements.enalbed: true</li>
  <li>create a policy</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2alpha1"
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  serviceSelector:
    matchLabels:
      color: blue
  nodeSelector:
    matchExpressions:
      - key: node-role.kubernetes.io/control-plane
        operator: DoesNotExist
  interfaces:
  - ^eth[0-9]+
  externalIPs: true
  loadBalancerIPs: true
</code></pre>
