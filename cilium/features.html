<!--
title: features
description: 
published: true
date: 2025-12-14T09:10:10.947Z
tags: 
editor: ckeditor
dateCreated: 2025-12-09T18:50:53.314Z
-->

<h2>IPAM</h2>
<ul>
  <li>Each node get a slice of the POD CIDR.</li>
  <li>IPAM modes:<ul>
      <li>kubernetes host scope: the allocation of node specific CIDR range is assigned by kubernetes control plane (kube-controller-manager). pass the following options in the manifest file:<ul>
          <li>--allocate-node-cidrs=true</li>
          <li>--cluster-cidr</li>
          <li>--node-cidr-mask-size</li>
          <li>cilium poll the API server to get the Node resource and search for spec.podCIDR range and use it to assign IPs for pods.</li>
          <li>The Kubernetes host-scope IPAM mode is enabled with <code>ipam: kubernetes.</code> in the values.yaml</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">apiVersion: v1
kind: Node
metadata:
  annotations:
    kubeadm.alpha.kubernetes.io/cri-socket: unix:///var/run/containerd/containerd.sock
    node.alpha.kubernetes.io/ttl: "0"
    volumes.kubernetes.io/controller-managed-attach-detach: "true"
  creationTimestamp: "2025-12-09T14:17:33Z"
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/os: linux
    kubernetes.io/arch: amd64
    kubernetes.io/hostname: k8s-worker01
    kubernetes.io/os: linux
  name: k8s-worker01
  resourceVersion: "32821"
  uid: b3b8a079-7110-472f-9df4-cf91cc8d8b56
spec:
  podCIDR: 10.244.1.0/24
  podCIDRs:
  - 10.244.1.0/24
</code></pre>
<ul>
  <li>&nbsp;<ul>
      <li>Custer Scope (default)<ul>
          <li>Cilium operator allocate POD CIDRs to each node, and cilium use them.</li>
          <li>enabled by ipam.mode: “cluster-pool” and &nbsp;ipam.mode.operator.</li>
          <li>CiliumNode object stores the podCIDRs to use</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2
kind: CiliumNode
metadata:
  labels:
    beta.kubernetes.io/arch: amd64
    beta.kubernetes.io/os: linux
    kubernetes.io/arch: amd64
    kubernetes.io/hostname: k8s-master
    kubernetes.io/os: linux
    node-role.kubernetes.io/control-plane: ""
    node.kubernetes.io/exclude-from-external-load-balancers: ""
  name: k8s-master
  ownerReferences:
  - apiVersion: v1
    kind: Node
    name: k8s-master

spec:
  addresses:
  - ip: 10.200.130.134
    type: InternalIP
  - ip: 10.0.0.244
    type: CiliumInternalIP
  alibaba-cloud: {}
  azure: {}
  bootid: 5d16ffdf-11fb-4fd6-b762-a47fce3db6ac
  encryption: {}
  eni: {}
  health:
    ipv4: 10.0.0.148
  ingress: {}
  ipam:
    podCIDRs:
    - 10.0.0.0/24
    pools: {}
</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">kubectl exec cilium-pod -n kube-system -- cilium-dbg status --all-addresses

KVStore:                Disabled
Kubernetes:             Ok         1.33 (v1.33.6) [linux/amd64]
Kubernetes APIs:        ["EndpointSliceOrEndpoint", "cilium/v2::CiliumCIDRGroup", "cilium/v2::CiliumClusterwideNetworkPolicy", "cilium/v2::CiliumEndpoint", "cilium/v2::CiliumNetworkPolicy", "cilium/v2::CiliumNode", "core/v1::Pods", "networking.k8s.io/v1::NetworkPolicy"]
KubeProxyReplacement:   False
Host firewall:          Disabled
SRv6:                   Disabled
CNI Chaining:           none
CNI Config file:        successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist
Cilium:                 Ok   1.18.4 (v1.18.4-afda2aa9)
NodeMonitor:            Listening for events on 2 CPUs with 64x4096 of shared memory
Cilium health daemon:   Ok
IPAM:                   IPv4: 7/254 allocated from 10.0.1.0/24,
Allocated addresses:
  10.0.1.118 (cilium-test-1/client3-795488bf5-hbnv7)
  10.0.1.126 (kube-system/hubble-relay-848bdc8547-gwrvs)
  10.0.1.181 (health)
  10.0.1.220 (router)
  10.0.1.243 (cilium-test-1/echo-other-node-6c6fdf86b5-nwk6z)
  10.0.1.51 (cilium-test-ccnp1/client-ccnp-df44777df-qddrp)
  10.0.1.62 (default/nginx)
IPv4 BIG TCP:            Disabled
IPv6 BIG TCP:            Disabled
BandwidthManager:        Disabled
Routing:                 Network: Tunnel [vxlan]   Host: Legacy
Attach Mode:             TCX
Device Mode:             veth
Masquerading:            IPTables [IPv4: Enabled, IPv6: Disabled]
Controller Status:       42/42 healthy
Proxy Status:            OK, ip 10.0.1.220, 0 redirects active on ports 10000-20000, Envoy: external
Global Identity Range:   min 256, max 65535
Hubble:                  Ok              Current/Max Flows: 4095/4095 (100.00%), Flows/s: 7.32   Metrics: Disabled
Encryption:              Disabled
Cluster health:          3/3 reachable   (2025-12-09T19:01:33Z)   (Probe interval: 1m56.754608943s)
Name                     IP              Node                     Endpoints
Modules Health:          Stopped(13) Degraded(0) OK(74)
</code></pre>
<ul>
  <li>&nbsp;<ul>
      <li>cloud-specific (aws,azure)</li>
      <li>multi-pool</li>
      <li>CRD backed</li>
    </ul>
  </li>
</ul>
<figure class="table">
  <table style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);">
    <thead>
      <tr>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>Feature</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>Kubernetes Host Scope</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>Cluster Scope (default)</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>Multi-Pool</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>CRD-backed</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>AWS ENI</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>Azure IPAM</strong></th>
        <th style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);border-right:1px solid rgb(225, 228, 229);border-top:1px solid rgb(225, 228, 229);padding:8px 16px;"><strong>GKE</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Tunnel routing</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
      </tr>
      <tr>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Direct routing</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
      </tr>
      <tr>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">CIDR Configuration</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Kubernetes</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Cilium</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Cilium</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">External</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">External (AWS)</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">External (Azure)</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">External (GCP)</td>
      </tr>
      <tr>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Multiple CIDRs per cluster</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
        <td style="background-color:transparent;border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
      </tr>
      <tr>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Multiple CIDRs per node</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="background-color:hsl(0, 0%, 0%);border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
        <td style="border-bottom:1px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">N/A</td>
      </tr>
      <tr>
        <td style="background-color:transparent;border-bottom:0px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">Dynamic CIDR/IP allocation</td>
        <td style="background-color:transparent;border-bottom:0px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="background-color:transparent;border-bottom:0px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">❌</td>
        <td style="background-color:transparent;border-bottom:0px solid rgb(225, 228, 229);border-left:1px solid rgb(225, 228, 229);padding:8px 16px;">✅</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
    </tbody>
  </table>
</figure>
<blockquote>
  <p>Do not ever change the IPAM mode in existing cluster</p>
</blockquote>
<h2>Routing Modes</h2>
<ol>
  <li>Encapsulation: The network packet from one pod is sent to the interface that is connected to its namespace, and the packet is encapsulated by the nodes IPs.</li>
</ol>
<figure class="image"><img src="/encap.png"></figure>
<ul>
  <li>Use VXLAN or Geneve protocols to encapsulate the packet, which adds some overhead to the packet.</li>
</ul>
<blockquote>
  <p>&nbsp;Virtual Extensible LAN (VXLAN): &nbsp;provide a <u>Layer 3</u> overlay network to resolve VLANs' inability to be routed and limited range of 4,096 VLANs per switching domain.</p>
</blockquote>
<figure class="image image_resized" style="width:100%;"><img src="/how_a_vxlan_works-f.png"></figure>
<p>&nbsp; 2. Native mode:</p>
<ul>
  <li>No encapsulation, Pod send its packet to the original namespace on the host, then the original namespace has route table to send traffic to the external routes, which are configured to route packets from the internal pods subnet. This can be achieved statically or dynamically.</li>
  <li>Statically, you can add routing rules in each router. Or use cilium ability to run routing protocols as BGP peering to dynamically configure connected routers (advertising their route tables)</li>
  <li>routingMode: “native”, and ipv4NativeRoutingCIDR: “POD CIDR of the whole cluster or only subnet from it and if the pod ip is out of this subnet cilium will fall back to tunnel encapsulation mode”</li>
</ul>
<figure class="image"><img src="/natvie.png"></figure>
<h2>Kube-Proxy less</h2>
<ul>
  <li>Cilium replaces the functionality of the kubeproxy by implementing eBPF programs.</li>
  <li>eBPF uses hash table to search for rules</li>
  <li>kubeProxyReplacement: “true”, k8sServiceHost: “api server IP”, k8sServicePort: “6443”</li>
</ul>
<pre><code class="language-plaintext">kubectl -n kube-system exec ds/cilium -- cilium-dbg status | grep KubeProxyReplacement</code></pre>
<ul>
  <li>To delete the kubeproxy<ul>
      <li>delete the kubeproxy daemonset, kube-proxy configmap</li>
      <li>delete the ip tables that it made</li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">iptables-save | grep -v KUBE | iptables-restore</code></pre>
<pre><code class="language-plaintext">kubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
