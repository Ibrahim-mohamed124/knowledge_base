<!--
title: Network Policies
description: 
published: true
date: 2025-12-19T19:42:05.728Z
tags: 
editor: ckeditor
dateCreated: 2025-12-14T10:26:09.443Z
-->

<h2>The advantages of cilium network polices</h2>
<ul>
  <li>Cilium is able to <mark class="marker-yellow">control traffic at the layer 7 </mark>unlike the simple network policies that work on later 2 and 3 only</li>
  <li>Cilium is able to<mark class="marker-yellow"> match endpoints by &nbsp;(ICMP, DNS)</mark>
    <ul>
      <li>spec.ingress[].from.fwdn.matchDNS &nbsp;&gt; allow only traffic to the IPs that came from resolving this DNS name unlike other networkpolicies that need specific IPs.</li>
    </ul>
  </li>
  <li>Cilium is able to <mark class="marker-yellow">match pods by their service accounts</mark></li>
  <li>Multi-Cluster policy:<ul>
      <li>podSelector.matchLabels.cluster</li>
    </ul>
  </li>
  <li>Deny policies<ul>
      <li>spec.ingressDeny</li>
    </ul>
  </li>
  <li>Cluster-wide policies</li>
</ul>
<h3>cilium network policy</h3>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "layer 3"
  namespace: test
spec:
  endpointSelector:
    matchLabels:
       key: value
  ingress:
   - fromEndpoints:
   	  - {}
  egress:
   - toEndpoints:
    - matchLabels:
       key: value</code></pre>
<p>&nbsp;</p>
<ul>
  <li>to match endpoints to services</li>
</ul>
<pre><code class="language-plaintext">spec:
	egress:
	- toServices:
	  - k8sService:
	      serviceName: test
	      namespace: test
     - k8sServiceSelector:
         selector:
           matchlabels:
             test: test2
         namespace: test2</code></pre>
<p>&nbsp;</p>
<ul>
  <li>to match on DIDR</li>
</ul>
<pre><code class="language-plaintext">egress:
- toCIDR:
  - 0.0.0.0/0
- toCIDRSet:
  - cidr: 0.0.0.0/0
    except:
     - 0.0.0.0/0</code></pre>
<p>&nbsp;</p>
<ul>
  <li>layer 4 matching</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "layer 3"
  namespace: test
spec:
  endpointSelector:
    matchLabels:
       key: value
  egress:
   - toPorts:
    - ports:
       - port: 80
         endPort: 100
         protocol: TCP</code></pre>
<p>&nbsp;</p>
<ul>
  <li>the rules are complied using AND (same item in the list) or OR (two separate items on the list)</li>
  <li>Layer 7 http</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "layer 3"
  namespace: test
spec:
  endpointSelector:
    matchLabels:
       key: value
  ingress:
  - fromEndpoints:
     - matchLabels:
        key: value 
    toPorts:
    - ports:
      - port: 80
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/products"</code></pre>
<p>&nbsp;</p>
<ul>
  <li>layer 7 DNS</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "layer 3"
  namespace: test
spec:
  endpointSelector:
    matchLabels:
       key: value
  egress:
  - toEndpoints:
    - matchLabels:
       k8s:io.kubernetes.pod.namespace: kube-system
       k8s:k8s-app: kube-dns
    toPorts:
     - ports:
        - port: "53"
          protocol: ANY
       rules:
        dns:
          - matchName: "google.com"
          - matchPattern: "*.google.com"</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "layer 3"
  namespace: test
spec:
  endpointSelector:
    matchLabels:
       key: value
  egress:
  - toEndpoints:
    - matchLabels:
       k8s:io.kubernetes.pod.namespace: kube-system
       k8s:k8s-app:kube-dns
    toPorts:
     - ports:
        - port: 53
          protocol: ANY
  - toFQDNs:
     - matchName: google.com
     - matchPattern: *.google.com
    toPorts:
     - ports:
        - port: "80"
          protocol: TCP </code></pre>
<ul>
  <li>Entities:<ul>
      <li>preserved keywords for certain endpoints<ul>
          <li>ex: kube-apiserver target the kube-apiserver endpoints</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">egress:
  - toEntities:
  		- kube-apiserver</code></pre>
<p>&nbsp;</p>
<ul>
  <li>&nbsp;<ul>
      <li>&nbsp;<ul>
          <li>localhost: control if host process can access the pods that are running on the same node or remote-node to allow process from other nodes to connect to the pods on other nodes</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">ingress:
  - fromEntites:
    - host
    - remote-node</code></pre>
<p>&nbsp;</p>
<ul>
  <li>&nbsp;<ul>
      <li>&nbsp;<ul>
          <li>world: only allow traffic from outside the cluster</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">ingress:
 - fromEntites:
    - world</code></pre>
<p>&nbsp;</p>
<ul>
  <li>DenyPolicy: takes precedence</li>
</ul>
<pre><code class="language-plaintext">ingressDeny:
 - fromEndpoints:
   - matchLabels:
     key: value</code></pre>
<p>&nbsp;</p>
<ul>
  <li>cluster wide policies:</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CililumClusterwideNetworkPolicy
metadata:
	name: allow-dns
spec:
	endpointSelector: {}
	egress:
	- toEndpoints:
	  - matchLabels:
	     k8s-app: kube-dns
	     io.kubernetes.pod.namespace: kube-system
	  toPorts:
	  - port: "53"
	    protocol: UDP
	  - port: "53"
	    protocol: TCP</code></pre>
<p>&nbsp;</p>
<ul>
  <li>deny all</li>
</ul>
<pre><code class="language-plaintext">spec:
 ingrss: {}</code></pre>
<p>&nbsp;</p>
<ul>
  <li>allow all</li>
</ul>
<pre><code class="language-plaintext">spec:
  ingress:
   - fromEndpoints: {}</code></pre>
<p>&nbsp;</p>
<ul>
  <li>specifying namespaces</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "db"
  namespace: staging
spec:
  endpointSelector:
    matchLabels:
      role: backend
  ingress:
   - fromEndpoints:
     - matchLabels:
        role: frontend
       matchExpressions:
       - key: k8s:io.kubernetes.pod.namespace
         operator: In
         values:
           - staging
           - prod</code></pre>
<p>&nbsp;</p>
<ul>
  <li>cluster wide DNS policy to all FQDNs</li>
</ul>
<pre><code class="language-plaintext">apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: allow-dns-clusterwide
spec:
  endpointSelector: {}
  egress:
  - toEndpoints:
    - matchLabels:
        k8s:io.kubernetes.pod.namespace: kube-system
        k8s:k8s-app: kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: ANY
      rules:
        dns:
        - matchPattern: "*"</code></pre>
<h4>policy audit mode</h4>
<ul>
  <li>Do not drop any traffic only logs events when not allowed traffic arrives.&nbsp;<ul>
      <li>Enable it for all endpoints &gt; policyAuditMode: true in the values.yaml for cilium helm chart</li>
      <li>for specific endpoints connect to one pod of the cilium deployment&nbsp;</li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">kubectl -n kube-system exec cilium-pod -c cilium-agent -- cilium-dbg endpoint config endpoint-name policyAuditMode=Enabled</code></pre>
<p>&nbsp;</p>
