<!--
title: Loki_lab
description: 
published: true
date: 2025-12-05T09:18:19.187Z
tags: 
editor: ckeditor
dateCreated: 2025-12-04T20:19:08.042Z
-->

<h1>Configuring Logging for OpenShift</h1>
<ul>
  <li>To get started with logging, you must install the following Operators:<ul>
      <li><mark class="marker-yellow">Loki Operator </mark>to manage your log store.</li>
      <li><mark class="marker-yellow">Red Hat OpenShift Logging Operator</mark> to manage log collection and forwarding. (must be installed after configuring the lokistack log store)</li>
      <li><mark class="marker-yellow">Cluster Observability Operator</mark> (COO) to manage visualization.</li>
    </ul>
  </li>
</ul>
<h1>Create the LokiStack instance</h1>
<blockquote>
  <p>Openshift logging &nbsp;does not use ClusterLogging anymore, and it is replaced by only ClusterLogForwarder.</p>
</blockquote>
<ol>
  <li>Download Loki operator and enable monitoring</li>
  <li>Provide object storage from the odf or minio.</li>
  <li>create a secret with the following data<ol>
      <li>ACCESS<i>KEY</i>ID</li>
      <li>ACCESSKEYSECRET</li>
      <li>BUCKETNAME</li>
      <li>THE INTERNAL SERVICE OF THE BUCKET ENDPOINT &gt;&gt;<ul>
          <li>http://minio-api.minio-ocp.svc.cluster.local:9000</li>
          <li>or use odf &gt;&gt;&gt;&gt;&gt;&gt;&gt; &nbsp;s3.openshift-storage.svc:443</li>
        </ul>
      </li>
    </ol>
  </li>
</ol>
<blockquote>
  <p>when using the route of the bucket provider as endpoint some problems come up with the ca.crt</p>
</blockquote>
<pre><code class="language-plaintext">apiVersion: v1
kind: Secret
metadata:
  name: logging-loki-s3 
  namespace: openshift-logging
stringData: 
  access_key_id: &lt;access_key_id&gt;
  access_key_secret: &lt;secret_access_key&gt;
  bucketnames: &lt;s3_bucket_name&gt;
  endpoint: 
</code></pre>
<pre><code class="language-plaintext">oc extract secret/logging-loki-minio -n openshift-logging --to=-
# access_key_id
27DZ27VF5lC0k0vycECw
# access_key_secret
LbYKvnUJMG4L1FCzsUmxq9ZwB9F6fmtnF7843DYG
# bucketnames
loki
# endpoint
http://minio-api.minio-ocp.svc.cluster.local:9000
</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc extract secret/logging-loki-odf -n openshift-logging --to=-
# access_key_id
JT7e6tax80DbheYk4607
# access_key_secret
9t74zADpfKQBDisylmO770dVTURuV1tmxXBXfY6I
# bucketnames
loki-bucket-odf-e7997377-7cb7-4cce-9207-646d6683b685
# endpoint
https://s3.openshift-storage.svc:443</code></pre>
<p>&nbsp; 3. Create a <code>LokiStack</code> resource YAML file for an instance called <code>logging-loki</code> in the <code>openshift-logging</code> namespace.</p>
<pre><code class="language-plaintext">apiVersion: loki.grafana.com/v1
kind: LokiStack
metadata:
  name: logging-loki
  namespace: openshift-logging
spec:
  size: 1x.demo
  storage:
    secret:
      name: logging-loki-odf
      type: s3
    tls:
      caName: openshift-service-ca.crt  &gt;&gt; odf
  storageClassName: ocs-external-storagecluster-ceph-rbd
  tenants:
    mode: openshift-logging</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: loki.grafana.com/v1
kind: LokiStack
metadata:
  name: lokistack
  namespace: openshift-logging
spec:
  size: 1x.extra-small
  storage:
     secret:
      name: logging-loki-minio  &gt;&gt; minio
      type: s3
  storageClassName: portworx-sc
  tenants:
    mode: openshift-logging</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc get po
NAME                                        READY   STATUS    RESTARTS   AGE
cluster-logging-operator-565f5d5c56-rx2bd   1/1     Running   0          3h28m
logging-rzqcp                               1/1     Running   0          36m
logging-ts8mz                               1/1     Running   0          36m
logging-xmb62                               1/1     Running   0          36m
lokistack-compactor-0                       1/1     Running   0          38m
lokistack-distributor-567785dbc-2cmjt       1/1     Running   0          38m
lokistack-distributor-567785dbc-79cp9       1/1     Running   0          38m
lokistack-gateway-76fc664c64-z6g9n          2/2     Running   0          38m
lokistack-gateway-76fc664c64-zmxk2          2/2     Running   0          38m
lokistack-index-gateway-0                   1/1     Running   0          38m
lokistack-index-gateway-1                   1/1     Running   0          38m
lokistack-ingester-0                        1/1     Running   0          38m
lokistack-ingester-1                        1/1     Running   0          37m
lokistack-querier-66c4f49475-66z7s          1/1     Running   0          38m
lokistack-querier-66c4f49475-x4b7t          1/1     Running   0          38m
lokistack-query-frontend-6db57976d4-cgtr2   1/1     Running   0          38m
lokistack-query-frontend-6db57976d4-chhb4   1/1     Running   0          38m
</code></pre>
<h1>Create the ClusterLogForwarder</h1>
<ol>
  <li>Create a service account for the collector. If you want to write logs to storage that requires a token for authentication, <mark class="marker-yellow">you must include a token in the service account</mark>.</li>
</ol>
<pre><code class="language-plaintext">oc create sa colloctor -n openshift-logging</code></pre>
<blockquote>
  <p>serviceaccounts can have more than one token that are stored in secrets</p>
  <pre><code class="language-plaintext">oc describe sa tet
Name:                tet
Namespace:           ibrahim
Labels:              &lt;none&gt;
Annotations:         &lt;none&gt;
Image pull secrets:  &lt;none&gt;
Mountable secrets:   &lt;none&gt;
Tokens:              test1
                     test2
Events:              &lt;none&gt;
</code></pre>
  <pre><code class="language-plaintext">apiVersion: v1
data:
  token: "echo "token" | based4 -w 0"
kind: Secret
metadata:
  annotations:
    kubernetes.io/service-account.name: tet
    kubernetes.io/service-account.uid: bec90966-4769-4cfc-bc5d-58516380e0e9
  name: test2
  namespace: ibrahim
type: kubernetes.io/service-account-token
</code></pre>
</blockquote>
<p>&nbsp; 2. Explicitly grant log collection permissions to the service account associated with <strong>ClusterLogForwarder&nbsp;</strong></p>
<ul>
  <li>Add this clusterrolebinding to the operator to allow it to manage Kubernetes resources cluster-wide.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: manager-rolebinding
roleRef:                                           
  apiGroup: rbac.authorization.k8s.io              
  kind: ClusterRole                                
  name: cluster-logging-operator                   
subjects:                                          
  - kind: ServiceAccount                           
    name: cluster-logging-operator                 
    namespace: openshift-logging   </code></pre>
<blockquote>
  <p>collect-application-logs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>
  <p>collect-audit-logs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>
  <p>collect-infrastructure-logs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</p>
  <p>logging-collector-logs-writer &nbsp;</p>
  <p><mark class="marker-yellow">These clusterroles are created by default by openshift-logging operator&nbsp;</mark></p>
</blockquote>
<pre><code class="language-plaintext">oc adm policy add-cluster-role-to-user logging-collector-logs-writer -z collector </code></pre>
<pre><code class="language-plaintext">oc adm policy add-cluster-role-to-user collect-application-logs -z collector</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc adm policy add-cluster-role-to-user collect-infrastructure-logs -z collector</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc adm policy add-cluster-role-to-user collect-audit-logs -z collector</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-logging-write-audit-logs
rules:                                              
  - apiGroups:                                      
      - loki.grafana.com                            
    resources:                                      
      - audit                                       
    resourceNames:                                  
      - logs                                        
    verbs:                                          
      - create                                      </code></pre>
<pre><code class="language-plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-logging-write-application-logs
rules:                                              
  - apiGroups:                                      
      - loki.grafana.com                            
    resources:                                      
      - application                                 
    resourceNames:                                  
      - logs                                        
    verbs:                                          
      - create                                      </code></pre>
<pre><code class="language-plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-logging-write-infrastructure-logs
rules:                                              
  - apiGroups:                                      
      - loki.grafana.com                            
    resources:                                      
      - infrastructure                              
    resourceNames:                                  
      - logs                                        
    verbs:                                          
      - create                                      </code></pre>
<pre><code class="language-plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: clusterlogforwarder-editor-role
rules:                                              
  - apiGroups:                                      
      - observability.openshift.io                  
    resources:                                      
      - clusterlogforwarders                        
    verbs:                                          
      - create                                      
      - delete                                      
      - get                                         
      - list                                        
      - patch                                       
      - update                                      
      - watch                                       </code></pre>
<pre><code class="language-plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: clusterlogforwarder-editor-role
rules:                                              
  - apiGroups:                                      
      - observability.openshift.io                  
    resources:                                      
      - clusterlogforwarders                        
    verbs:                                          
      - create                                      
      - delete                                      
      - get                                         
      - list                                        
      - patch                                       
      - update                                      
      - watch                                       </code></pre>
<p>&nbsp; 4. modify the log level in the collector, you can set the <code>observability.openshift.io/log-level</code> annotation to <code>trace</code>, <code>debug</code>, <code>info</code>, <code>warn</code>, <code>error</code>, and <code>off</code>.</p>
<pre><code class="language-plaintext">apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: collector
  annotations:
    observability.openshift.io/log-level: debug
# ...</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: logging
  namespace: openshift-logging
spec:
  managementState: Managed
  outputs:
  - lokiStack:
      authentication:
        token:
          from: serviceAccount
      target:
        name: lokistack
        namespace: openshift-logging
    name: logging-loki
    tls:
      ca:
        configMapName: openshift-service-ca.crt
        key: service-ca.crt
    type: lokiStack
  pipelines:
  - inputRefs:
    - application
    - infrastructure
    name: logs-to-loki
    outputRefs:
    - logging-loki
  serviceAccount:
    name: collector
</code></pre>
<blockquote>
  <p>the openshift logging operator will create a secret that include a token for the service account that is associated with it.</p>
  <pre><code class="language-plaintext">kind: Secret
metadata:
  annotations:
    kubernetes.io/service-account.name: collector
    kubernetes.io/service-account.uid: 7a712b81-72ee-4e3a-96bd-acc9ac69ace6
  creationTimestamp: "2025-12-04T19:43:09Z"
  labels:
    kubernetes.io/legacy-token-last-used: "2025-12-05"
  name: collector-token
  namespace: openshift-logging
  ownerReferences:
  - apiVersion: observability.openshift.io/v1
    controller: true
    kind: ClusterLogForwarder
    name: logging
    uid: 211312e7-0d21-4445-9dd3-5acc9bef960e
  resourceVersion: "524344"
  uid: 7ec62c05-47ea-442c-9003-7d5265c6d768
type: kubernetes.io/service-account-token
</code></pre>
</blockquote>
<ul>
  <li>to tune the logging system</li>
</ul>
<pre><code class="language-plaintext">apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
# ...
spec:
  # ...
  outputs:
  - name: default-lokistack
    type: lokiStack
    lokiStack:
      tuning:
        deliveryMode: AtLeastOnce 
        compression: none 
        maxWrite: &lt;integer&gt; 
        minRetryDuration: 1s 
        maxRetryDuration: 1s 
# ...</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: "observability.openshift.io/v1"
kind: ClusterLogForwarder
metadata:
  name: &lt;log_forwarder_name&gt;
  namespace: &lt;log_forwarder_namespace&gt;
spec:
  serviceAccount:
    name: &lt;service_account_name&gt;
  filters:
  - name: &lt;name&gt;
    type: detectMultilineException
  pipelines:
    - inputRefs:
        - &lt;input-name&gt;
      name: &lt;pipeline-name&gt;
      filterRefs:
        - &lt;filter-name&gt;
      outputRefs:
        - &lt;output-name&gt;</code></pre>
<p><a href="https://docs.redhat.com/en/documentation/red_hat_openshift_logging/6.4/html-single/configuring_logging/index#legacy-service-accounts">https://docs.redhat.com/en/documentation/red_hat_openshift_logging/6.4/html-single/configuring_logging/index#legacy-service-accounts</a></p>
