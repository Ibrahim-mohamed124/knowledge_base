<!--
title: Anthos Upgrades
description: 
published: true
date: 2026-02-12T16:40:19.062Z
tags: 
editor: ckeditor
dateCreated: 2026-02-12T16:07:34.419Z
-->

<blockquote>
  <p>This documents assumes that all the clusters are updated to the recommended features and the cluster is not advanced cluster</p>
</blockquote>
<h1>Overview of cluster upgrades</h1>
<h6>Essentials&nbsp;</h6>
<ul>
  <li>The gkectl command line version must be the same as the target version of the clusters</li>
  <li>The Admin cluster version must be equal or higher than the User cluster version</li>
  <li>The gkectl command line version cannot be higher than the current cluster version by 2 minor versions</li>
</ul>
<h6>Upgrade sequence</h6>
<ol>
  <li>Upgrade the admin workstation</li>
  <li>Upgrade the admin cluster</li>
  <li>Upgrade the user clusters, one at a time</li>
</ol>
<blockquote>
  <p>For Controlplane V2, the user cluster control plane nodes are upgraded during the user cluster upgrade, and the admin cluster control plane nodes are upgraded during the admin cluster upgrade.</p>
</blockquote>
<blockquote>
  <p>When upgrading user clusters, you can choose to upgrade the user cluster as a whole (meaning you can upgrade the control plane and all node pools in the cluster), or you can upgrade the user cluster's control plane and leave the node pools at the current version. Which approach you take depends on several factors, such as:</p>
  <ul>
    <li>The environment (production or non-production) that the cluster is in.</li>
    <li>The length of your maintenance window.</li>
    <li>The version of the user cluster.</li>
  </ul>
</blockquote>
<h6>Upgrade tool</h6>
<ul>
  <li>The command-line tool <code>gkectl</code>, which you run on your admin workstation. Before the upgrade, you modify your user cluster <a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/user-cluster-configuration-file-latest#nodepool-gkeonpremversion-field">configuration file</a> to set the target version for the cluster's control plane and optionally, for the node pools. You specify this file on the command line to <code>gkectl</code>.</li>
</ul>
<h1>Best practices</h1>
<h6>Upgrade checklist</h6>
<ul class="todo-list">
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#estimate_the_time_commitment_and_plan_a_maintenance_window"><span class="text-tiny"><label class="todo-list__label"><u><input type="checkbox" disabled="disabled"></u><span class="todo-list__label__description"><u>Estimate the time commitment and plan a maintenance window</u></span></label><span class="todo-list__label__description"> for the upgrade.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#back_up_the_user_and_admin_cluster"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Prepare backups for the user clusters and admin cluster</span></label><span class="todo-list__label__description">.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#review_the_use_of_poddisruptionbudgets"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Check for </span></label><code><span class="todo-list__label__description">PodDisruptionBudgets</span></code><span class="todo-list__label__description"> in user clusters.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#review_the_available_ip_addresses"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Review the available IP addresses</span></label><span class="todo-list__label__description"> and needs.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#check_cluster_utilization"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Check the user cluster utilization</span></label><span class="todo-list__label__description"> and available resources.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#check_vsphere_utilization"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Check the vSphere cluster capacity</span></label><span class="todo-list__label__description"> for available resources such as CPU, memory, and ready times.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#check_cluster_health"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Check the cluster health and configuration</span></label><span class="todo-list__label__description"> to resolve problems before the upgrade.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#use_deployments_to_minimize_application_disruption"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Use Deployments to minimize application disruption</span></label><span class="todo-list__label__description">.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#use_a_high_availability_load_balancer_pair"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Use a high availability load balancer pair</span></label><span class="todo-list__label__description">.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#decide_how_to_upgrade_each_user_cluster"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Decide how to upgrade each user cluster</span></label><span class="todo-list__label__description">.</span></span></a></li>
  <li><a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/upgrade-best-practices#check_ca_certificates"><span class="text-tiny"><label class="todo-list__label"><input type="checkbox" disabled="disabled"><span class="todo-list__label__description">Check if CA certificates need to be rotated</span></label><span class="todo-list__label__description">.</span></span></a></li>
</ul>
<h6>Downtime</h6>
<ul>
  <li>During the upgrade Anthos drains the nodes, and recreates them</li>
  <li>To calculate a rough estimate for the upgrade time, multiply 15 minutes times the number of nodes in the largest node pool. For example, if you have 10 nodes in the largest pool, the total upgrade time would be about 15 * 10 = 150 minutes or 2.5 hours</li>
  <li>Accelerate an upgrade by setting the value of <a href="https://docs.cloud.google.com/kubernetes-engine/distributed-cloud/vmware/docs/how-to/user-cluster-configuration-file-latest#nodepool-update-policy-updatestrategy-rolling-update-maxsurge-field"><code>maxSurge</code></a> for individual node pools.&nbsp;</li>
</ul>
<h6>Back up the user cluster</h6>
<ul>
  <li>check if the cluster is controlplane V2</li>
</ul>
<pre><code class="language-plaintext">kubectl get onpremuserclusters --kubeconfig USER_CLUSTER_KUBECONFIG \
  -n kube-system -o jsonpath='{.items[0].spec.enableControlplaneV2}' &amp;&amp; echo</code></pre>
<ul>
  <li>Get the etcd Pod's name:</li>
</ul>
<pre><code class="language-plaintext">kubectl --kubeconfig USER_CLUSTER_KUBECONFIG get pods \
 -n kube-system -l component=etcd,tier=control-plane -ojsonpath='{$.items[*].metadata.name}{"\n"}'</code></pre>
<ul>
  <li>Get a shell into the <code>etcd</code> container:</li>
</ul>
<pre><code class="language-plaintext">kubectl --kubeconfig USER_CLUSTER_KUBECONFIG exec -it \
 POD_NAME -c etcd -n kube-system -- /bin/sh
</code></pre>
<ul>
  <li>In your shell, create a backup file named <code>snapshot.db</code>:</li>
</ul>
<pre><code class="language-plaintext">ETCDCTL_API=3 etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  snapshot save /tmp/snapshot.db</code></pre>
<ul>
  <li>Copy <code>snapshot.db</code> from the <code>etcd</code> container to the workstation home directory:</li>
</ul>
<pre><code class="language-plaintext">kubectl --kubeconfig USER_CLUSTER_KUBECONFIG \
 cp POD_NAME:/tmp/snapshot.db ~/snapshot.db \
 -c etcd -n kube-system</code></pre>
<ul>
  <li>Copy the secrets from the PKI directory:</li>
</ul>
<pre><code class="language-plaintext">ssh -i NODE_NAME.key ubuntu@NODE_EXTERNAL_IP
sudo chmod -R 0644 /etc/kubernetes/pki/*
sudo chmod 0755 /etc/kubernetes/pki/etcd
exit
scp -ri NODE_NAME.key ubuntu@NODE_EXTERNAL_IP:/etc/kubernetes/pki ~/pki_NODE_NAME</code></pre>
<h6>Backup admin cluster</h6>
<ul>
  <li>Edit the admin cluster configuration file and add the <code>clusterBackup.datastore</code> field, then run <code>gkectl update admin</code>.</li>
</ul>
<pre><code class="language-plaintext">gkectl  backup admin --kubeconfig ADMIN_CLUSTER_KUBECONFIG --config ADMIN_CLUSTER_CONFIG</code></pre>
<h6>Review the use of <code>PodDisruptionBudgets</code></h6>
<pre><code class="language-plaintext">kubectl get pdb -A --kubeconfig KUBECONFIG</code></pre>
<p>&nbsp;</p>
