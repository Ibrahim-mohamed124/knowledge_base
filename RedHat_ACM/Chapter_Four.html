<!--
title: Chapter_Four ~ Water
description: 
published: true
date: 2025-10-20T07:23:31.248Z
tags: 
editor: ckeditor
dateCreated: 2025-10-19T11:32:32.884Z
-->

<h3>RHACM Observability Components</h3>
<ul>
  <li>Prometheus: time-series data data collection</li>
  <li>Thanos: A toolkit of components that<mark class="marker-yellow"> gathers data from multiple Prometheus instances</mark> that are running on different OpenShift clusters, and enables global querying. You can use any<mark class="marker-yellow"> S3-compatible storage for long-term storage of Prometheus data.</mark></li>
  <li>Alertmanager: A tool to manage and <mark class="marker-yellow">receive alerts from Prometheus.</mark></li>
</ul>
<figure class="image"><img src="/obs-arch.png"></figure>
<h4>components&nbsp;</h4>
<ol>
  <li><code>multiclusterhub-operator</code> pod: deploys the <code>multicluster-observability-operator</code> pod by default</li>
  <li><code>multicluster-observability-operator: </code>sends hub cluster data to the managed clusters.<ul>
      <li>Watches for new managed clusters and automatically deploys metric and alert collection services to the managed clusters.</li>
    </ul>
  </li>
  <li><code>observability-endpoint-operator</code> pod: automatically deployed to each imported or created managed cluster. This controller starts a metrics collector that collects and sends the data<mark class="marker-yellow"> from OpenShift Prometheus</mark> to the RHACM hub cluster.</li>
  <li>observability add-on controller: API server that automatically updates the log of the managed clusters.</li>
  <li>Thanos Compactor:<ul>
      <li>ensures that queries are performing well by using the retention configuration and compaction of the data in storage.</li>
      <li>Deployed by <code>multicluster-observability-operator</code></li>
    </ul>
  </li>
  <li>Grafana: visualization</li>
</ol>
<h3>Configuration</h3>
<ul>
  <li>The RHACM observability service is always installed in the hub cluster, although it is not enabled by default, due to the requirements for persistent storage, CPU, and memory.</li>
</ul>
<h4>Prerequisites for the Observability Service</h4>
<p>You must meet the following conditions to enable the observability service:</p>
<ul>
  <li>A user with the cluster administrator role, the <code>open-cluster-management:cluster-manager-admin</code> role, or an S3 administrator</li>
  <li>To define a storage class in the <code>MultiClusterObservability</code> custom resource, if no default storage class is specified</li>
  <li>To have direct network access to the hub cluster</li>
  <li>To configure an object store to create a storage solution. RHACM supports Amazon Web Services S3, Google Cloud Storage, and Red&nbsp;Hat OpenShift Data Foundation, among other cloud providers.</li>
  <li>The observability components require 2701&nbsp;m CPU and 11972&nbsp;Mi memory to enable the observability service.</li>
</ul>
<pre><code class="language-plaintext"> oc create namespace open-cluster-management-observability
 DOCKER_CONFIG_JSON=oc extract  secret/multiclusterhub-operator-pull-secret \
   -n open-cluster-management --to=-
   or
 DOCKER_CONFIG_JSON=oc extract   secret/pull-secret -n openshift-config --to=-
 oc create secret generic multiclusterhub-operator-pull-secret \
  -n open-cluster-management-observability \
  --from-literal=.dockerconfigjson="$DOCKER_CONFIG_JSON" \
  --type=kubernetes.io/dockerconfigjson</code></pre>
<p>&nbsp;</p>
<ul>
  <li>The RHACM observability service needs a persistent object store. The following YAML example defines an <code>ObjectBucketClaim</code> named <code>thanos-obc</code> that uses the <code>openshift-storage.noobaa.io</code> storage class that<mark class="marker-yellow"> Red&nbsp;Hat OpenShift Data Foundation provides.</mark></li>
  <li>Red&nbsp;Hat OpenShift Data Foundation creates, with the same name, <mark class="marker-yellow">a matching secret and a configuration map, which contain the bucket information and credentials.</mark></li>
</ul>
<pre><code class="language-plaintext">apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim

metadata:
  name: thanos-obc
  namespace: open-cluster-management-observability
spec:
  storageClassName: openshift-storage.noobaa.io
  generateBucketName: observability-bucket</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc extract --to=- cm/thanos-obc \
  -n open-cluster-management-observability
# BUCKET_REGION

# BUCKET_SUBREGION

# BUCKET_HOST
s3.openshift-storage.svc
# BUCKET_NAME
thanos-obc-b2cdf931-0ec5-41a9-9b31-033d360d3a38
# BUCKET_PORT
443</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext"> oc extract --to=- secret/thanos-obc \
  -n open-cluster-management-observability
# AWS_SECRET_ACCESS_KEY
MWykFQTUVUHLw3Lgjvts+WUBu2QH6hF1XLuXYYsR
# AWS_ACCESS_KEY_ID
Z9VYaOjvJVveQ1Az4rkX</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Create the <code>thanos-object-storage</code> secret within the <code>open-cluster-management-observability</code> namespace by using the information from the configuration map and the credentials from the secret.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: v1
kind: Secret
metadata:
  name: thanos-object-storage
  namespace: open-cluster-management-observability
type: Opaque
stringData:
  thanos.yaml: |
    type: s3
    config:
      bucket: thanos-obc-b2cdf931-0ec5-41a9-9b31-033d360d3a38
      endpoint: s3.openshift-storage.svc
      insecure: true
      access_key: Z9VYaOjvJVveQ1Az4rkX
      secret_key: MWykFQTUVUHLw3Lgjvts+WUBu2QH6hF1XLuXYYsR</code></pre>
<p>&nbsp;</p>
<ul>
  <li>To enable the observability service, you must create a <code>MultiClusterObservability</code> custom resource instance in the <code>open-cluster-management-observability</code> namespace. The <code>MultiClusterObservability</code> object requires a secret that contains the credentials of the S3 bucket storage.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: observability.open-cluster-management.io/v1beta2
kind: MultiClusterObservability
metadata:
  name: observability
spec:
  enableDownsampling: true 
  observabilityAddonSpec: 
    enableMetrics: true 
    interval: 30
  storageConfig: 
    metricObjectStorage: 
      key: thanos.yaml
      name: thanos-object-storage 
    alertmanagerStorageSize: 1Gi 
    compactStorageSize: 20Gi 
    receiveStorageSize: 20Gi 
    ruleStorageSize: 1Gi 
    storeStorageSize: 10Gi 
    storageClass: ocs-external-storagecluster-ceph-rbd 12
  nodeSelector: 
    node-role.kubernetes.io/infra:</code></pre>
<p>&nbsp;</p>
<ul>
  <li>The creation of the <code>MultiClusterObservability</code> resource creates the pods for Thanos, Alertmanager, and Grafana in the <code>open-cluster-management-observability</code> namespace.</li>
  <li>&nbsp;</li>
</ul>
<p>&nbsp;</p>
