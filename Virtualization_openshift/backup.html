<!--
title: backup
description: 
published: true
date: 2025-11-21T11:54:46.393Z
tags: 
editor: ckeditor
dateCreated: 2025-11-20T11:42:16.843Z
-->

<p>Exporting and Importing Virtual Machines</p>
<ul>
  <li>OpenShift Virtualization provides a <code>VirtualMachineExport</code> custom resource to export a VM and its volumes.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: export.kubevirt.io/v1alpha1
kind: VirtualMachineExport
metadata:
  name: fedora-export
  namespace: vms
spec:
  source:
    apiGroup: "kubevirt.io"
    kind: VirtualMachine
    name: fedora-vm 1
  ttlDuration: 1h 2</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the virtual machine to export</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Amount of time before the automatic deletion of the export</td>
      </tr>
    </tbody>
  </table>
</figure>
<pre><code class="language-plaintext">oc get vmexport
oc describe vmexport/fedora-export
Name:         fedora-export
Namespace:    vms
...output omitted...
Status:
  Links:
    External:
      Manifests: 1
        Type:  all
        URL:   https://virt-exportproxy-openshift-cnv.apps.ocp4.example.com/…/external/manifests/all
      ...output omitted...
      Volumes: 2
        Name:      fedora-vm
        Formats:
          Format:  gzip
          URL:     https://virt-exportproxy-openshift-cnv.apps.ocp4.example.com/…/volumes/fedora-vm/disk.img.gz
    ...output omitted...
    Internal: 3
      Manifests:
        Type:  all
        URL:   https://virt-export-fedora-export.vms.svc/internal/manifests/all
      Volumes:
        Name:     fedora-vm
        Formats:
          Format: gzip
          URL:    https://virt-export-fedora-export.vms.svc/volumes/fedora-vm/disk.img.gz
  ...output omitted...
  Phase:                 Ready
  Service Name:          virt-export-fedora-export
  Token Secret Ref:      export-token-fedora-export 4
  Ttl Expiration Time:   2024-04-19T14:19:16Z 5
  Virtual Machine Name:  fedora-vm</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Download links for the VM manifest bundle.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Download links for each VM volume. VM disks are available in two format types: <code>raw</code> for an unaltered raw disk image, and <code>gzip</code> for a compressed raw disk image.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Internal links for the manifest and volumes. Those links are valid only inside the cluster.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the secret with the export token.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Expiration date and time for the export.</td>
      </tr>
    </tbody>
  </table>
</figure>
<ul>
  <li>The download links are protected with an export token that is generated in the <code>export-token-<i>export_name</i></code> secret</li>
  <li>If the TTL is not specified, then the default value is two hours. After that time, OpenShift Virtualization deletes the <code>VirtualMachineExport</code> resource.</li>
</ul>
<pre><code class="language-plaintext">virtctl vmexport create \
  --vm=fedora-vm \ 1
  fedora-export 2</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the virtual machine to export</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the <code>VirtualMachineExport</code> resource to create</td>
      </tr>
    </tbody>
  </table>
</figure>
<pre><code class="language-plaintext">virtctl vmexport download \
  fedora-export \ 1
  --keep-vme \ 2
  --manifest \ 3
  --include-secret \ 4
  --output fedora-vm.yml 5</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the <code>VirtualMachineExport</code> resource.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>virtctl</code> command automatically deletes the <code>VirtualMachineExport</code> resource after the download is complete. Use the <code>--keep-vme</code> option to keep the <code>VirtualMachineExport</code> resource.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Use the <code>--manifest</code> option to download the manifest bundle, and the <code>--volume</code> option to download the VM disk.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Include the export token secret in the manifest bundle.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">File name for the manifest or disk on your local machine.</td>
      </tr>
    </tbody>
  </table>
</figure>
<blockquote>
  <p>The manifest bundle contains the VM manifest, the CA certificate, and the required export token secret for downloading the volume image from the OpenShift cluster.&nbsp;</p>
</blockquote>
<ul>
  <li>example of manifest bundle:</li>
</ul>
<pre><code class="language-plaintext">---
apiVersion: v1
kind: ConfigMap 1
metadata:
  name: export-ca-cm-fedora-export
...output omitted...
---
apiVersion: v1
kind: Secret 2
metadata:
  name: header-secret-fedora-export
...output omitted...
---
apiVersion: kubevirt.io/v1
kind: VirtualMachine 3
metadata:
...output omitted...
  name: fedora-vm
  namespace: vms
spec:
  dataVolumeTemplates:
  - apiVersion: cdi.kubevirt.io/v1beta1
    kind: DataVolume 4
    metadata:
      creationTimestamp: null
      name: fedora-vm
    spec:
      source:
        http:
          certConfigMap: export-ca-cm-fedora-export
          secretExtraHeaders:
          - header-secret-fedora-export
          url: https://virt-exportproxy-openshift-cnv.apps.ocp4.example.com/…/volumes/fedora-vm/disk.img.gz  5
...output omitted...</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Configuration map with the CA certificate</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Secret with the export token</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Virtual machine definition</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Data volume definition that uses the CA certificate and the export token to download the volume image from the source OpenShift Virtualization cluster</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The source URL, which is a single line.</td>
      </tr>
    </tbody>
  </table>
</figure>
<pre><code class="language-plaintext"> virtctl vmexport download \
  fedora-export \
  --keep-vme \
  --volume fedora-vm \ 1
  --output fedora-vm-disk.img.gz 2</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the volume to export.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">File name for the volume image on your local machine. You can use the <code>.img</code> extension for the raw volume image, and the <code>.img.gz</code> extension for the compressed image.</td>
      </tr>
    </tbody>
  </table>
</figure>
<blockquote>
  <p>To ensure data consistency, you must stop the VM before exporting it. If the VM is running, then the <code>VirtualMachineExport</code> resource stays in the <code>Pending</code> state until the VM is shut down.</p>
</blockquote>
<ul>
  <li>to export data from a vm:<ol>
      <li>create a snapshot</li>
      <li>use the <code>virtctl vmexport</code> command to export the VM from the snapshot</li>
    </ol>
  </li>
</ul>
<pre><code class="language-plaintext">virtctl vmexport create \
  --snapshot=fedora-snapshot \
  fedora-export-snapshot
  
oc get vmexport</code></pre>
<p>&nbsp;</p>
<ul>
  <li>To import the vm to another cluster apply the manifest bundle file.</li>
</ul>
<blockquote>
  <p>OpenShift Virtualization imports the VM into the same namespace as the source cluster. You must create that namespace on the target cluster before importing the VM.</p>
</blockquote>
<ul>
  <li>to import volumes:</li>
</ul>
<pre><code class="language-plaintext">virtctl image-upload dv \
  fedora-rootdisk \ 1
  --size 30Gi \ 2
  --image-path fedora-vm-disk.img.gz \ 3
  --storage-class ocs-external-storagecluster-ceph-rbd-virtualization 4</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Name of the data volume to create</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Size of the data volume, which must be large enough for the image to import</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Path of the disk image on your local machine to import</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Storage class for the data volume</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<h3>Take Snapshots of Virtual Machines</h3>
<ul>
  <li>Red&nbsp;Hat OpenShift Virtualization can take live snapshots of running VMs, as well as snapshots of stopped VMs.</li>
  <li>OpenShift Virtualization communicates with the Quick Emulator (QEMU) guest agent that is running inside the VM to quiesce the file systems before taking the snapshot.</li>
  <li>If one VM disk relies on back-end storage that does not support snapshots, then OpenShift Virtualization displays a warning message when you take a snapshot.</li>
  <li>Red&nbsp;Hat supports taking a live snapshot of a VM with hot-plugged disks. However, the snapshot includes only the hot-plugged disks in the VM specification. <i>Hot-plugged</i> refers to disks that you attach to a running VM.</li>
  <li>A VM snapshot also records the VM configuration, such as the number of CPUs or the amount of memory.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: snapshot.kubevirt.io/v1alpha1
kind: VirtualMachineSnapshot
metadata:
  name: mariadb-server-2024-10-23
spec:
  source:
    apiGroup: kubevirt.io
    kind: VirtualMachine
    name: mariadb-server</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc get virtualmachinesnapshot</code></pre>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: snapshot.kubevirt.io/v1alpha1
kind: VirtualMachineRestore
metadata:
  name: restore-db
spec:
  target:
    apiGroup: kubevirt.io
    kind: VirtualMachine
    name: mariadb-server
  virtualMachineSnapshotName: mariadb-server-2024-10-23</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h3>Copy Kubernetes Volume Snapshots</h3>
<ul>
  <li>VM snapshots rely on Kubernetes volume snapshots. When you take a snapshot of a VM, OpenShift Virtualization creates a Kubernetes volume snapshot for each VM disk.</li>
</ul>
<h4>Backing up a Virtual Machine by OADP</h4>
<ul>
  <li>OADP can back up virtual machines that are running on the OpenShift cluster. To back up a virtual machine, you must include the <code>kubevirt.io/virtualmachine</code> resource type in the backup definition.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: velero.io/v1
kind: Backup
metadata:
  name: my-vm-backup
  namespace: openshift-adp
spec:
  includedNamespaces:
  - my-vm
  includedResources:
  - kubevirt.io/virtualmachine
  hooks:
    resources:
    - name: my-vm-pre-backup
      labelSelector:
        matchLabels:
          kubevirt.io/virtualmachine: my-vm
      pre:
      - exec:
          container: my-vm
          command:
          - /usr/bin/virsh
          - suspend</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre><code class="language-plaintext">apiVersion: velero.io/v1
kind: Restore
metadata:
  name: my-vm-restore
  namespace: openshift-adp
spec:
  backupName: my-vm-backup
  hooks:
    resources:
    - name: my-vm-post-restore
      labelSelector:
        matchLabels:
          kubevirt.io/virtualmachine: my-vm
      post:
      - exec:
          container: my-vm
          command:
          - /usr/bin/virsh
          - resume  my-vm</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Backing up Volumes with Kopia</li>
</ul>
<pre><code class="language-plaintext">apiVersion: velero.io/v1
kind: Backup
metadata:
  name: &lt;backup-name&gt;
  namespace: openshift-adp
spec:
  defaultVolumesToFsBackup: true</code></pre>
<p>&nbsp;</p>
<ul>
  <li>annotate the application pod to specify which volumes to back up with Kopia by using the<mark class="marker-yellow"> backup.velero.io/backup-volumes: volume1,volume2,volume3</mark> annotation.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: apps/v1
kind: Deployment
metadata:
  name: website-mariadb
  namespace: org-website
spec:
  template:
    metadata:
      annotations:
        backup.velero.io/backup-volumes: mariadb
    spec:
      containers:
        name: db
        image: registry.access.redhat.com/rhscl/mariadb-105-rhel7
        ...output omitted...
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: mariadb
      ...output omitted...
      volumes:
      - name: mariadb
        persistentVolumeClaim:
          claimName: mariadb-data
...output omitted...</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
