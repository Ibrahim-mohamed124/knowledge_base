<!--
title: Networking
description: 
published: true
date: 2025-11-19T11:39:56.436Z
tags: network
editor: ckeditor
dateCreated: 2025-11-18T16:45:53.502Z
-->

<blockquote>
  <p><i>Software-Defined Network (SDN): E</i>nables Kubernetes to control the network traffic and the network resources programmatically, similar to the VMware vSwitch software program.</p>
</blockquote>
<h1>Cluster Network Operator</h1>
<ul>
  <li>Manages the SDN by calling a <mark class="marker-yellow">plug-in</mark> that adheres to the <mark class="marker-yellow">Container Network Interface</mark> (CNI) specification to configure container network interfaces like:<ul>
      <li>OVN-Kubernetes</li>
      <li>Kuryr</li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>OVN-Kubernetes provider, which runs the Open <mark class="marker-yellow">vSwitch (OVS) plug-in on each node</mark>, is selected by default during installation.</p>
</blockquote>
<blockquote>
  <p><strong>the vswitch plugin does not replace kube‑proxy.</strong> In OpenShift, kube‑proxy is still responsible for implementing Kubernetes Service semantics (cluster IPs, NodePorts, load‑balancing). The vswitch (part of the OpenShift SDN or OVN‑Kubernetes plugin) handles <i>pod‑to‑pod networking and policy enforcement</i></p>
</blockquote>
<figure class="image image_resized" style="width:100%;"><img src="/pod-sdn.svg"></figure>
<figure class="image image_resized" style="width:100%;"><img src="/pod-service-sdn.svg"></figure>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc get network/cluster -o yaml
apiVersion: config.openshift.io/v1
kind: Network
metadata:
...output omitted...
spec:
  clusterNetwork:
  - cidr: 10.8.0.0/14 1
    hostPrefix: 23
  externalIP:
     policy: {}
  networkType: OVNKubernetes
  serviceNetwork:
  - 172.30.0.0/16 2
...output omitted...</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The pod network CIDR</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The service network CIDR</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<h4>DNS Operator&nbsp;</h4>
<ul>
  <li>Deploys and runs a DNS server, which monitors the services to automatically create and update the DNS records.</li>
  <li>Manages the <code>svc.cluster.local</code> domain name for services, and creates records in the <code>servicename.namespace.svc.cluster.local</code> format.</li>
  <li>The operator automatically creates the <code>/etc/resolv.conf</code> configuration file inside the pods so that name resolution is immediately available without further configuration.</li>
</ul>
<h4>Exposing a vm</h4>
<ul>
  <li>The <code>virt-launcher</code> process that runs inside the pod runs a Dynamic Host Configuration Protocol (DHCP) server, which provides an<mark class="marker-yellow"> IP address and the DNS configuration to the VM.</mark></li>
  <li>The <code>virt-launcher</code> pod redirects the inbound traffic to the VM and routes the outbound traffic to its destination.</li>
  <li>After editing a <code>VirtualMachine</code> resource manifest, Kubernetes does not automatically propagate the changes to the <code>VirtualMachineInstance</code> and <code>virt-launcher</code> pod resources.&nbsp;<mark class="marker-yellow"> Restart the VM to re-create the resources and apply the latest changes.</mark></li>
</ul>
<blockquote>
  <p>When you restart a VM resource in OpenShift:</p>
  <ol>
    <li>The VM controller <strong>terminates the current VMI</strong> (the running instance).</li>
    <li>A <strong>new VMI object and virt-lanucher pod are created</strong> to represent the restarted VM.</li>
    <li>The new VMI goes through the full boot process again (cloud‑init, disk attach, network setup).</li>
  </ol>
  <p>So yes — restarting a VM destroys the existing VMI and creates a new one. This is by design: VMIs are ephemeral objects tied to the current execution of the VM.</p>
</blockquote>
<ul>
  <li>To label a vm without restarting it label its virt-lanucher pod ( temporary solution, when restarting the vm the label will be gone )</li>
  <li><code>virtctl</code> tool &nbsp;provides a way to create a service from the command line.</li>
</ul>
<pre><code class="language-plaintext"> virtctl expose vmi backendvm --name backend \
  --type ClusterIP --port 80 --target-port 8080</code></pre>
<h4>Headless Service for a Virtual Machine</h4>
<ul>
  <li>A headless service creates a DNS entry that ties a DNS name to the IP address of a pod.</li>
</ul>
<h4>Set a Cluster-scoped Network Policy</h4>
<ul>
  <li><code>AdminNetworkPolicy</code> (ANP) resource: &nbsp;a cluster-scoped network policy that can restrict or enable access<mark class="marker-yellow"> before creating the targeted namespace</mark></li>
  <li>The ANP resource is similar to a namespace-scoped network policy, with three additional attributes: the <code>subject</code>, the <code>priority</code>, and the <code>action</code> attributes.<ul>
      <li><code>subject</code> attribute identifies the namespaces or pods that the ANP applies to\</li>
      <li><code>priority</code> attribute determines the order of evaluation. The lower the value, the higher the precedence. The priority attribute takes a value from 0-99. If two ANP policies have conflicting rules, then <mark class="marker-yellow">the policy with the lower-priority attribute value takes precedence over the other rule.</mark></li>
      <li><code>action</code> attribute takes a value of <code>Allow</code>, <code>Deny</code>, or <code>Pass</code>.</li>
    </ul>
  </li>
</ul>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <thead>
      <tr>
        <th style="padding:5px;vertical-align:top;"><strong>Action</strong></th>
        <th style="padding:5px;vertical-align:top;"><strong>Meaning</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="padding:5px;vertical-align:top;">Allow</td>
        <td style="padding:5px;vertical-align:top;">Allow ingress or egress</td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">Deny</td>
        <td style="padding:5px;vertical-align:top;">Deny ingress or egress</td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">Pass</td>
        <td style="padding:5px;vertical-align:top;">Defer access control to the namespaced network policies</td>
      </tr>
    </tbody>
  </table>
</figure>
<ul>
  <li>Namespaced network policies cannot override an ANP that uses <code>Allow</code> or <code>Deny</code> actions.&nbsp;<br>&nbsp;</li>
</ul>
<pre><code class="language-plaintext">apiVersion: policy.networking.k8s.io/v1alpha1
kind: AdminNetworkPolicy
metadata:
  name: sample-anp-allow-monitoring 1
spec:
  priority: 50 2
  subject:
    namespaces:
      matchLabels:
        security: unrestricted 3
  ingress: 4
  - name: "allow-monitoring-unrestricted" 5
    action: "Allow" 6
    from:
    - namespaces:
        matchLabels:
          kubernetes.io/metadata.name: monitoring</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Specify a name for the ANP.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>priority</code> field determines the precedence of the traffic rules.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Use labels to select the namespaces to which the rules apply.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">ANPs have both ingress and egress rules.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Specify a name for the ANP rule.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/6.svg" alt="6"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>action</code> value can be <code>Allow</code>, <code>Deny</code>, or <code>Pass</code>.</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<blockquote>
  <p>Non-cloud environments can also configure an <code>External IP</code> to send traffic to services by using the <code>LoadBalancer</code> service type. The <code>External IP</code> feature is disabled by default and can be a security risk, because sensitive in-cluster traffic that is destined for external resources might be intercepted.</p>
</blockquote>
<h4>Ingress Operator</h4>
<ul>
  <li>Manages the Ingress Controller, and provides the typical way to enable external access to cluster resources. The Ingress Controller is limited to HTTP, HTTPS, and TLS by using SNI, and is configured to accept external requests and to proxy them based on configured routes.</li>
</ul>
<h4>Red&nbsp;Hat OpenShift routes</h4>
<ul>
  <li>A route connects a public-facing DNS hostname to an internal-facing service IP.</li>
</ul>
<figure class="image image_resized" style="width:100%;"><img src="/route.svg"></figure>
<ul>
  <li>Red&nbsp;Hat OpenShift assigns a name in the <code><i>routename-namespace.default_domain</i></code> format.</li>
  <li>For other traffic types, such as UDP traffic or non-web TCP traffic, Red&nbsp;Hat recommends that you use services of the <code>LoadBalancer</code> or the <code>NodePort</code> type.</li>
  <li>Routes could be hostname or path based</li>
</ul>
<pre><code class="language-plaintext"> oc expose service/web --name web \
  --hostname web-production.apps.mycompany.com
 oc expose service/restapi --path=/api \
  --hostname=intranet-prod.apps.mycompany.com</code></pre>
<p>&nbsp;</p>
<ul>
  <li>the <code>oc expose</code> command can create only unencrypted routes. Use the <code>oc create route</code> command instead to create encrypted routes.</li>
</ul>
<pre><code class="language-plaintext">oc create route edge \ 
  --service web \ 
  --hostname api.apps.acme.com </code></pre>
<p>&nbsp;</p>
<blockquote>
  <p>When you use network policies in your project, you must add a rule to enable the traffic that comes from the router pods. Otherwise, the <code>route</code> resources do not work, because the router pods cannot reach the destination pods and virtual machines.</p>
  <p>&nbsp;<code><strong>network.openshift.io/policy-group: ingress</strong></code> &nbsp; &gt; label to be used in the networkpolicy</p>
</blockquote>
<p>&nbsp;</p>
<h2>Exposing Non-HTTP Services</h2>
<figure class="image image_resized" style="width:100%;"><img src="/nodeport.svg"></figure>
<blockquote>
  <p>Although the <code>NodePort</code> service type can be used for TCP and UDP traffic, Red&nbsp;Hat recommends avoiding doing so, for the following reasons:</p>
  <ol>
    <li>You must expose the IP addresses of your cluster nodes from outside the cluster. The node IP exposure is a security risk.</li>
    <li>You cannot select a port outside the default range (30000 to 32767).</li>
    <li>In cloud environments, the IP address of cluster nodes might not be permanent. For example, the cloud infrastructure might add or remove nodes to adapt the cluster to the load.</li>
    <li>A NodePort service might require additional network configuration to enable external access to the port.</li>
  </ol>
</blockquote>
<p>&nbsp;</p>
<figure class="image image_resized" style="width:100%;"><img src="/loadbalancer.svg"></figure>
<p>&nbsp;</p>
<h3>The MetalLB Operator</h3>
<ul>
  <li>MetalLB operates in two modes: layer 2 by using Address Resolution Protocol (ARP) and layer 3 by using Border Gateway Protocol (BGP).<ul>
      <li><strong>Layer 2 (ARP)</strong>
        <ul>
          <li>set by default when MetalLB is installed and configured with the MetalLB Operator.</li>
          <li>Layer 2 uses &nbsp;ARP packets to advertise the IP address of the load balancer service.</li>
        </ul>
      </li>
      <li><strong>Layer 3 (BGP)</strong>
        <ul>
          <li>The layer 3 mode uses BGP to advertise the routes for the load balancer services to other BGP peers(external routers).</li>
          <li>Requires a Autonomous System (AS) number (each node of the cluster advertise itself to the external routers as a gateway for this IP)</li>
          <li>When a router receives traffic for the load balancer service, the router picks one of the nodes that advertised the load balancer IP address.</li>
          <li>The router sends the traffic to that node, and the service proxy for the CNI network plug-in distributes the traffic to all the pods that match the service selector.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>MetalLB need an IP address range to control the IP addresses that can be assigned for load balancer services.</li>
</ul>
<pre><code class="language-plaintext">oc get metallb -n metallb-system</code></pre>
<p>&nbsp;</p>
<ul>
  <li>The IPAddressPool custom resource contains the range of IP addresses that MetalLB can allocate to the load balancer services.</li>
</ul>
<pre><code class="language-plaintext"> oc get ipaddresspool -n metallb-system</code></pre>
<pre><code class="language-plaintext"> apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: cheap
  namespace: metallb-system
spec:
  addresses:
  - 192.168.10.0/24</code></pre>
<ul>
  <li>The L2Advertisement custom resource enables advertising the load balancer IP addresses that the selected pools provide with gratuitous ARP packets on layer 2.</li>
</ul>
<pre><code class="language-plaintext">oc get l2advertisement -n metallb-system</code></pre>
<h3>Using Load Balancer Services with VMs</h3>
<ul>
  <li>The <code>kubevirt.io/domain=vm1</code> label represents the VM name, and it is passed to the VMI and the <code>virt-launcher</code> pod when the VM is started.</li>
  <li>VMs that are created by using instance types, the <code>vm.kubevirt.io/name</code> label is applied to the <code>virt-launcher</code> pod.</li>
  <li>These labels can be used as selectors for the service</li>
  <li>Pass only one <code>--port</code> parameter when creating the service with the <code>oc expose</code> command. You can edit the Kubernetes load balancer service resource manifest to add more ports, if needed. Because the <code>--port</code> parameter adds a single port, it does not add a name parameter to the port. However, the manifest requires the name parameter when multiple ports are configured.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: v1
kind: Service
metadata:
  labels:
    kubevirt.io/domain: email-server	1
    ...output omitted...
  name: email-server
spec:
  ports:
  - port: 25	2
    name: smtp	3
    protocol: TCP
    targetPort: 25
  - port: 587	4
    name: submission
    protocol: TCP
    targetPort: 587
  - port: 993	5
    name: imaps
    protocol: TCP
    targetPort: 993
  - port: 995	6
    name: pop3s
    protocol: TCP
    targetPort: 995
  selector:
    kubevirt.io/domain: email-server	7
  type: LoadBalancer	8
status:
  loadBalancer: {}</code></pre>
<p>&nbsp;</p>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>kubevirt.io/domain</code> label represents the VM name.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Exposes port 25 for SMTP traffic</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The name is optional when only one port is present in the service definition. However, the name is required when adding multiple ports to a service.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Exposes port 587 for SMTP traffic over TLS.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Exposes port 993 for IMAP traffic over SSL.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/6.svg" alt="6"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">Exposes port 995 for POP3 traffic over SSL.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/7.svg" alt="7"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The service selector that matches the pod labels.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/8.svg" alt="8"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The service type is set to load balancer.</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<h2>Advanced Networking with Multus CNI</h2>
<blockquote>
  <p>Before you configure additional networks for VMs, a Linux bridge must be configured and attached to your VM-workload nodes by applying a configuration manifest to the cluster.</p>
</blockquote>
<ul>
  <li>the Multus CNI plug-in calls other CNI plug-ins for advanced networking functions, such as attaching multiple network interfaces to pods in an OpenShift cluster.</li>
  <li>With Multus CNI, you can configure additional networks alongside the default pod network during and after your OpenShift cluster installation. Attaching multiple networks to a VM is called <i>multihoming</i>.</li>
</ul>
<figure class="image image_resized" style="width:100%;"><img src="/multus-interfaces.svg"></figure>
<p>&nbsp;</p>
<ul>
  <li><mark class="marker-yellow">Cluster Network Addons Operator (CNAO) </mark>manages additional network configurations for VMs that are based on the Multus CNI plug-in.</li>
  <li>The Multus CNI plug-in is implemented through the <code>NetworkAttachmentDefinition</code> CR. (Network Plumbing Working Group project )</li>
  <li>A network attachment definition is a namespaced object that exposes existing layer-2 network devices, such as bridges and switches, to VMs and pods.</li>
</ul>
<pre><code class="language-plaintext">apiVersion: "k8s.cni.cncf.io/v1"
kind: NetworkAttachmentDefinition
metadata:
  name: bridge-dev  1
  annotations:
    k8s.v1.cni.cncf.io/resourceName: bridge.network.kubevirt.io/bridge-dev 2
spec:
  config: '{
    "cniVersion": "0.3.1",
    "name": "bridge-dev",  3
    "type": "cnv-bridge",  4
    "bridge": "dev-bridge", 5
    "macspoofchk": true, 6
    "vlan": 0 7
  }'</code></pre>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The name for the network attachment definition.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;"><strong>Optional</strong>: An annotation key-value pair to determine the node selection for VM scheduling and execution. In this example, the <code>bridge-dev</code> bridge is configured on some cluster nodes. VMs that are attached to this network are scheduled only on a node with the <code>bridge-dev</code> bridge.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The name for the configuration, which Red&nbsp;Hat recommends should match the name of the network attachment definition.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The name of the CNI plug-in to use. Change this field only if using a different CNI plug-in.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The name of the Linux bridge that is configured on the node.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/6.svg" alt="6"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;"><strong>Optional</strong>: When set to <code>true</code>, the MAC address of the pod or a guest interface cannot be changed, and only one MAC address exits the pod.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/7.svg" alt="7"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;"><strong>Optional</strong>: The VLAN tag of the network.</td>
      </tr>
    </tbody>
  </table>
</figure>
<ul>
  <li>The available CNI plugins:<ul>
      <li><strong>bridge: &nbsp;</strong>
        <ul>
          <li>an additional bridge-based network to enable pods on the same host to communicate with each other and with the host.</li>
          <li>use a Linux bridge to<mark class="marker-yellow"> connect the network interfaces of VMs and pods to a physical network interface on a host or a node.</mark></li>
          <li>If the host has access to networks that are external to the OpenShift cluster, then bridge networks enable VMs and pods in the OpenShift cluster to communicate with resources that exist on that external network, such as file shares or databases.</li>
        </ul>
      </li>
      <li><strong>host-device:</strong>
        <ul>
          <li>additional host-device network to enable VMs and pods to have exclusive access to a physical Ethernet network device on the host system.</li>
        </ul>
      </li>
      <li><strong>ipvlan:</strong>
        <ul>
          <li>enable pods and VMs on a host to have unique IP addresses, but have the same MAC address as the host's physical network.&nbsp;</li>
          <li><mark class="marker-yellow">IP range of the host's physical device is shared with the pods and VMs that are connected to an IPVLAN-based network.&nbsp;</mark></li>
        </ul>
      </li>
      <li><strong>macvlan:</strong>
        <ul>
          <li>pod and VM that are attached to a MACVLAN additional network have a unique MAC address.</li>
        </ul>
      </li>
      <li><strong>SR-IOV:</strong>
        <ul>
          <li>Configure an additional SR-IOV network to enable pods to attach to a virtual function interface on SR-IOV-capable hardware on the host system.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre><code class="language-plaintext">oc get net-attach-def -n multus-test</code></pre>
<p>&nbsp;</p>
<h2>The Kubernetes NMState Operator</h2>
<ul>
  <li>The Kubernetes NMState operator provides a centralized and declarative<mark class="marker-yellow"> host network configuration tool</mark> in a Red&nbsp;Hat OpenShift cluster.</li>
  <li>The operator reports the node network configuration, validates configuration syntax, and applies network configuration changes without a node reboot.</li>
  <li>configure additional node network devices, such as Linux bridges, and use them in network attachment definitions.</li>
</ul>
<blockquote>
  <p>Figure 4.2: Creating the NMState instance</p>
  <p>The NMState operator provides three API resources for managing the network configuration:</p>
  <ol>
    <li><code>NodeNetworkState</code></li>
    <li><code>NodeNetworkConfigurationPolicy</code></li>
    <li><code>NodeNetworkConfigurationEnactment</code></li>
  </ol>
</blockquote>
<blockquote>
  <p>The NMState operator manages the network configuration of the host nodes in an OpenShift cluster. Multus-CNI manages the network configuration of pods in a Kubernetes cluster. Multus works better together with the NMState operator, which offers a declarative way of configuring those network devices on cluster nodes.</p>
</blockquote>
<ul>
  <li><strong>Node Network State:</strong>
    <ul>
      <li>A node network state (NNS) resource exists on each cluster node and is periodically updated to include the state of the network for that node.&nbsp;</li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext"> oc get nns/node-name -o yaml 
 apiVersion: nmstate.io/v1beta1
kind: NodeNetworkState
metadata:
  name: worker01
  ...output omitted...
status:
  currentState:
    interfaces:
    - accept-all-mac-addresses: false
      controller: br-ex
      ...output omitted...
      ipv4:
        address:
        - ip: 192.168.50.13
          preferred-life-time: 437316606sec
          prefix-length: 24
          valid-life-time: 437316606sec
          ...output omitted...
        dhcp: true
        dhcp-send-hostname: true
        enabled: true
        ...output omitted...
      name: br-ex
      profile-name: ovs-if-br-ex
      state: up
      type: ovs-interface
      ...output omitted...</code></pre>
<ul>
  <li><strong>Node Network Configuration Policy:</strong>
    <ul>
      <li>A node network configuration policy (NNCP) describes the intended network configuration for OpenShift nodes.</li>
      <li>create and manage node network interfaces, such as declaring a Linux bridge, with a node network configuration policy.</li>
      <li>NMState can manage several interface types, such as Linux bridge, bonding, and Ethernet, configure additional options, such as Spanning Tree Protocol (STP) and IPv4 connectivity with an NNCP.<br>&nbsp;</li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: br1-policy 1
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: "" 2
  desiredState:
    interfaces:
    - name: br1 3
      description: Linux bridge with ens4 as a port 4
      type: linux-bridge 5
      state: up
      ipv4:
        dhcp: true
        enabled: true
      bridge:
        options:
          stp:
            enabled: false
        port:
        - name: ens4 6</code></pre>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <tbody>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/1.svg" alt="1"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The name for the node network configuration policy.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/2.svg" alt="2"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>nodeSelector</code> specifies that this policy applies to all compute nodes in the cluster. If the <code>nodeSelector</code> parameter is not included, then the policy applies to all nodes in the cluster.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/3.svg" alt="3"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>name</code> parameter specifies the chosen name for the configured interface.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/4.svg" alt="4"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">An optional description for the policy.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/5.svg" alt="5"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The <code>type</code> parameter specifies the type of connection to create.</td>
      </tr>
      <tr>
        <td style="padding:0px;vertical-align:top;">
          <figure class="image image_resized" style="width:22px;"><img src="https://rol.redhat.com/rol/static/roc/Common_Content/images/6.svg" alt="6"></figure>
        </td>
        <td style="padding:0px;vertical-align:top;">The physical interfaces on the node to use in the defined Linux bridge.</td>
      </tr>
    </tbody>
  </table>
</figure>
<pre><code class="language-plaintext">oc get nncp</code></pre>
<p>&nbsp;</p>
<blockquote>
  <p><mark class="marker-yellow">To remove an interface from a node,</mark> you must modify or create an NNCP that designates the interface as <code>absent</code> under the <code>state</code> parameter. When setting an interface's state to <code>absent</code>, the network interface that is configured with the bridge or bonding interface is placed in the <code>down</code> state and connectivity is lost.</p>
</blockquote>
<ul>
  <li><strong>Node Network Configuration Enactment:</strong>
    <ul>
      <li>NMState operator generates a <code>NodeNetworkConfigurationEnactment</code> (NNCE) object for<mark class="marker-yellow"> each cluster node</mark> that the policy affects.&nbsp;</li>
      <li>The NNCE object reports the execution status of an applied policy and includes the defined settings that the policy enacts on each node.</li>
      <li>In the event of a failure, the node rolls back to its prior configuration, and the NNCE provides traceback data to troubleshoot the failure.</li>
    </ul>
  </li>
</ul>
<pre><code class="language-plaintext">oc get nnce nnce-name -o yaml</code></pre>
<p>&nbsp;</p>
<h3>Kubernetes NMState with Multus in OpenShift Virtualization</h3>
<ul>
  <li>OpenShift Virtualization uses Multus Container Network Interface (CNI) plug-ins and the Kubernetes NMState Operator resources to create a<mark class="marker-yellow"> Linux bridge that connects VMs to additional networks</mark>. A Linux bridge forwards packets between connected interfaces, similar to the function of a network switch.</li>
  <li>&nbsp;Open vSwitch (OVS) bridge can be used &nbsp;instead of a Linux bridge to connect VMs to additional networks.</li>
</ul>
<p>&nbsp;</p>
<figure class="image image_resized" style="width:100%;"><img src="/nmstate-multus.svg"></figure>
<p>&nbsp;</p>
<blockquote>
  <p><code><strong>Bonding</strong></code></p>
  <ul>
    <li>Configure a bonding interface to aggregate multiple network interfaces into a single logical interface.</li>
    <li>Bonding interfaces provide fault tolerance and load balancing for network traffic. You can use bonding interfaces to connect VMs to a network by using multiple physical NICs to provide redundancy in the event of network failures.</li>
  </ul>
</blockquote>
<p>&nbsp;</p>
<h4>Connecting Virtual Machines to a Linux Bridge Network</h4>
<ol>
  <li>Linux bridge is configured on nodes through a node network configuration policy.</li>
  <li>Create a network attachment definition (NAD) in the same namespace of the vms before connecting the VMs to the bridge.<ul>
      <li>Any NADs that is created in the <code>default</code> namespace are available to all VMs in the cluster.</li>
    </ul>
  </li>
  <li>Use the CNV Linux Bridge CNI plug-in in the network attachment definition to connect a VM to an additional network on the Linux bridge.</li>
</ol>
<figure class="table">
  <table style="background-color:rgb(255, 255, 255);">
    <thead>
      <tr>
        <th style="padding:5px;vertical-align:top;" colspan="2"><strong>Creating a network attachment definition</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="padding:5px;vertical-align:top;">Name</td>
        <td style="padding:5px;vertical-align:top;"><code>br1-bridge-network</code></td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">Description</td>
        <td style="padding:5px;vertical-align:top;">Creating a network attachment definition</td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">Network type</td>
        <td style="padding:5px;vertical-align:top;">Linux bridge</td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">Bridge name</td>
        <td style="padding:5px;vertical-align:top;"><code>br1</code></td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">VLAN tag number</td>
        <td style="padding:5px;vertical-align:top;"><code>0</code></td>
      </tr>
      <tr>
        <td style="padding:5px;vertical-align:top;">MAC spoof check</td>
        <td style="padding:5px;vertical-align:top;"><i>Checked</i></td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
