<!--
title: Autopilot
description: 
published: true
date: 2025-11-21T18:35:33.196Z
tags: 
editor: ckeditor
dateCreated: 2025-11-21T18:18:27.986Z
-->

<h1>Autopilot</h1>
<p>‚úî Autopilot is a rule-based automation engine in Portworx that responds to monitored<mark class="marker-yellow"> changes in a Kubernetes environment</mark>. It enables dynamic cluster management by <mark class="marker-yellow">automatically executing predefined actions when certain conditions are met.</mark></p>
<p>üëâüëâ Examples of the actions that can be executed:</p>
<ul>
  <li>Autopilot can be used to resize PVCs when they run low on capacity</li>
  <li>scale Portworx storage pools as usage grows</li>
  <li>rebalance volumes across storage pools to ensure optimal resource distribution</li>
</ul>
<p>üíÅ‚Äç‚ôÇÔ∏èüíÅ‚Äç‚ôÇÔ∏è As the autopilot depend on runtime changes in Kubernetes, it needs a metrics server.</p>
<figure class="image"><img src="/autopilot-overview-20cbb7be90d4981984165b911be90f88.gif">
  <figcaption>Autopilot workflow</figcaption>
</figure>
<p>&nbsp;</p>
<h2><strong>Autopilot Install and Setup</strong></h2>
<p>üò° Steps:</p>
<ol>
  <li>OpenShift Prometheus instance in your cluster from the OCP monitoring stack</li>
</ol>
<pre><code class="language-plaintext">oc get route thanos-querier -n openshift-monitoring -o json | jq -r '.spec.host'</code></pre>
<p>&nbsp;</p>
<blockquote>
  <p><strong>Thanos Querier:</strong> A stateless service that aggregates query requests and retrieves data from the Sidecars (for recent data) and the Store Gateway (for historical data).</p>
</blockquote>
<p>&nbsp; 2. ensure that the autopilot is enabled in the StorageCluster specification:</p>
<pre><code class="language-plaintext">kind: StorageCluster
spec:
  autopilot:
    enabled: true</code></pre>
<p>&nbsp; 3.<strong> </strong>Customize Autopilot install:</p>
<ul>
  <li>modify the spec part of StorageCluster:</li>
</ul>
<pre><code class="language-plaintext">apiVersion: core.libopenstorage.org/v1
kind: StorageCluster
...
spec:
  autopilot:
    enabled: true
    image: portworx/autopilot:1.3.14
    providers:
    - name: default
      params:
        url: https://&lt;THANOS-QUERIER-HOST&gt;   &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; routes from before 
      type: prometheus
    args:
      log-level: debug</code></pre>
<p>&nbsp;</p>
<ul>
  <li><strong>Here are all the parameters that could be modified:</strong></li>
</ul>
<figure class="table">
  <table>
    <thead>
      <tr>
        <th style="background-color:rgba(0, 0, 0, 0);border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><strong>Parameter</strong></th>
        <th style="background-color:rgba(0, 0, 0, 0);border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><strong>Default Value</strong></th>
        <th style="background-color:rgba(0, 0, 0, 0);border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><strong>Description</strong></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.args.log-level</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>info</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">Determines the level of logs to be printed in Autopilot pod log. Can be set to <code>trace</code> or <code>debug</code> for troubleshooting.</td>
      </tr>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.args.min_poll_interval</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>5 (sec)</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">Frequency at which Autopilot checks conditions for all rules and proceeds with state changes.</td>
      </tr>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.providers.name</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>default</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">Name of the metrics provider.</td>
      </tr>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.providers.type</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>prometheus</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">Type of the metrics provider, currently only <code>prometheus</code> is supported.</td>
      </tr>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.providers.params.url</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>http://px-prometheus:9090</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">URL for the metrics provider where Autopilot scrapes volume/pool metrics. Default is the URL for Prometheus shipped with Portworx enterprise.</td>
      </tr>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.providers.params.ignore_unhealthy_targets</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>true</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">Determines whether to ignore unhealthy scraping targets and proceed with Autopilot actions. If set to <code>false</code>, Autopilot won't proceed if there are unhealthy targets.</td>
      </tr>
      <tr>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;"><code>stc.spec.Autopilot.resources.limits.memory</code></td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">&nbsp;</td>
        <td style="border-bottom:0.8px solid rgb(96, 103, 112);border-left:0.8px solid rgb(96, 103, 112);border-right:0.8px solid rgb(96, 103, 112);border-top:0.8px solid rgb(96, 103, 112);padding:12px;">Maximum memory size that can be claimed by Autopilot</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<h3>‚öî <strong>Autopilot with PX-Security</strong></h3>
<blockquote>
  <p>PX-Security refers to the security features of the Portworx platform, providing <mark class="marker-yellow">Role-Based Access Control (RBAC</mark>), <mark class="marker-yellow">authentication</mark>, <mark class="marker-yellow">ownership</mark>, and volume encryption for Kubernetes environments</p>
</blockquote>
<ul>
  <li>Add the following PX_SHARED_SECRET env var to the <code>autopilot</code> section:</li>
</ul>
<pre><code class="language-plaintext">  autopilot:
...
    env:
    - name: PX_SHARED_SECRET
      valueFrom:
        secretKeyRef:
          key: apps-secret
          name: px-system-secrets</code></pre>
<h3>üöÄ <strong>Upgrade Autopilot</strong></h3>
<ul>
  <li>To upgrade Autopilot to a custom image:<ol>
      <li>Update the <code>configmap/px-versions</code> with the desired custom Autopilot image.</li>
      <li>Add the <code>autoUpdateComponents</code> field to the storage cluster specification:</li>
    </ol>
  </li>
</ul>
<pre><code class="language-plaintext">kind: StorageCluster
spec:
  autoUpdateComponents: Once</code></pre>
<ul>
  <li>With Portworx Upgrade (without configmap):<ol>
      <li>Delete the <code>configmap/px-versions</code> file.<ul>
          <li>When Portworx is upgraded, the Operator will <mark class="marker-yellow">automatically upgrade the installed components to the recommended versions.</mark></li>
        </ul>
      </li>
      <li>Upgrade the Portworx image in the storage cluster specification to proceed with the upgrade.</li>
    </ol>
  </li>
  <li>With Portworx Upgrade (with configmap):<ol>
      <li>Download the latest Portworx version manifest:</li>
    </ol>
  </li>
</ul>
<pre><code class="language-plaintext">curl -o versions.yaml "https://install.portworx.com/$&lt;portworx-version&gt;/version?kbver=$&lt;kubernetes-version&gt;&amp;opver=$&lt;operator-version&gt;"</code></pre>
<blockquote>
  <p><code>&lt;portworx_version&gt;</code> with the Portworx version you want to use.</p>
  <p><code>&lt;kubernetes-version&gt;</code> with the Kubernetes version you want to use.</p>
  <p><code>&lt;operator-version&gt;</code> with the Operator version you want to use.</p>
</blockquote>
<p>&nbsp; &nbsp; &nbsp;2. &nbsp;Update the px-versions configmap with the downloaded version manifest:</p>
<pre><code class="language-plaintext">kubectl -n &lt;px-namespace&gt; delete configmap px-versions
kubectl -n &lt;px-namespace&gt; create configmap px-versions --from-file=versions.yaml</code></pre>
<p>&nbsp; &nbsp; 3. Add the <code>autoUpdateComponents</code> field to the storage cluster specification:</p>
<pre><code class="language-plaintext">kind: StorageCluster
spec:
  autoUpdateComponents: Once </code></pre>
<h2><strong>Working with Autopilot Rules</strong></h2>
<p>ü§î what is <strong>AutopilotRule?</strong></p>
<ul>
  <li>It is <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">CRD</a> to tell Autopilot <mark class="marker-yellow">which </mark>objects to monitor, the <mark class="marker-yellow">conditions </mark>to monitor, and the corresponding <mark class="marker-yellow">actions </mark>to perform when conditions occur.</li>
  <li>An AutopilotRule has 4 main parts:<ol>
      <li><strong>Selector</strong> <mark class="marker-yellow">Matches labels on the objects</mark> that the rule should monitor.</li>
      <li><strong>Namespace Selector</strong> <mark class="marker-yellow">Matches labels on the Kubernetes namespaces the rule should monitor</mark>. This is optional, and the default is all namespaces.</li>
      <li><strong>Conditions</strong> The <mark class="marker-yellow">metrics for the objects to monitor.</mark></li>
      <li><strong>Actions</strong> to <mark class="marker-yellow">perform</mark> once the metric conditions are met.</li>
    </ol>
  </li>
</ul>
<h3><a href="https://docs.portworx.com/portworx-enterprise/operations/scale-portworx-cluster/autopilot/reference"><strong>Creating an AutopilotRule&nbsp;</strong></a></h3>
<pre><code class="language-plaintext">apiVersion: autopilot.libopenstorage.org/v1alpha1
kind: AutopilotRule
metadata:
 name: volume-resize
spec:
  ##### selector filters the objects affected by this rule given labels
  selector:
    matchLabels:
      app: postgres
  ##### namespaceSelector selects the namespaces of the objects affected by this rule
  namespaceSelector:
    matchLabels:
      type: db
  ##### conditions are the symptoms to evaluate. All conditions are AND'ed
  conditions:
    # volume usage should be less than 50%
    expressions:
    - key: "100 * (px_volume_fs_usage_bytes / px_volume_capacity_bytes)"
      operator: Gt
      values:
        - "50"
  ##### action to perform when condition is true
  actions:
  - name: openstorage.io.action.volume/resize
    params:
      # resize volume by scalepercentage of current size
      scalepercentage: "100"
      # volume capacity should not exceed 400GiB
      maxsize: "400Gi"</code></pre>
<ul>
  <li>To monitor the autopilotRule:</li>
</ul>
<pre><code class="language-plaintext">oc get events --field-selector involvedObject.kind=AutopilotRule --all-namespaces</code></pre>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
