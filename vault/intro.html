<!--
title: Intro
description: 
published: true
date: 2025-10-07T18:07:58.692Z
tags: iac, vault, hashicorp
editor: ckeditor
dateCreated: 2025-10-06T20:02:56.809Z
-->

<h1>Vault</h1>
<ul>
  <li>Manage secrets and sensitive data</li>
  <li>provide single source of secrets</li>
  <li>Complete lifecycle management of secrets</li>
  <li>Provide governance for secrets access</li>
  <li>Dynamically secret generation</li>
  <li>Encryption as a service</li>
  <li>Root or intermediate certificates automatically &gt; PKI</li>
</ul>
<h2>How It Works?</h2>
<ol>
  <li>Authenticate &gt; temporary token generation</li>
  <li>Authorize &nbsp;&gt; specified in the token</li>
  <li>Operations</li>
</ol>
<h2>Components</h2>
<ol>
  <li>Storage Backends &gt; raft, consul</li>
  <li>Secret engines &gt; store, generate, encrypt data</li>
  <li>Authentication methods</li>
  <li>Audit devices</li>
</ol>
<h3>Storage Backends&nbsp;</h3>
<ul>
  <li>Configured in the main vault conf file</li>
  <li>each storage backends has different parameters</li>
  <li>Data is encrypted in-transit and at rest</li>
  <li>one storage backend per vault cluster</li>
</ul>
<h3>Secret Engines&nbsp;</h3>
<ul>
  <li>Secret Management</li>
  <li>Store, generate, and encrypt data</li>
  <li>Dynamic credentials generation</li>
  <li>More than one secret engine can be enabled in one cluster (different or the same secret engine)</li>
  <li><mark class="marker-green">Isolated by using paths&nbsp;</mark></li>
</ul>
<h3>Auth Methods</h3>
<ul>
  <li>user validation and assigning policies to users by generating tokens</li>
  <li>Multiple authentication methods can be used in one cluster &gt; for humans, machines..</li>
  <li>Token: includes policies and TTL</li>
</ul>
<h4>Audit Devices</h4>
<ul>
  <li>Json formatted logs for requests and responses</li>
  <li>Sensitive Information is hashed</li>
  <li>Many audit devices can be used &gt; non is enabled by default<ul>
      <li><mark class="marker-green">the log must be written first before responding to a client!</mark></li>
    </ul>
  </li>
</ul>
<h2>Architecture&nbsp;</h2>
<figure class="image image_resized" style="width:100%;"><img src="https://kodekloud.com/kk-media/image/upload/v1752878228/notes-assets/images/HashiCorp-Certified-Vault-Associate-Certification-Vault-Architecture-and-Pathing-Structure/vault-system-architecture-components-diagram.jpg" alt="The image illustrates the architecture of a Vault system, showing components like the core, token store, audit devices, and storage backend, along with API interaction and encrypted storage."></figure>
<ul>
  <li>Barrier: A virtual fence around the core components of vault (every thing expect the storage backend, the GUI(http/s), and the API)<ul>
      <li>Any data the move through the Barrier is encrypted and decrypted at the Barrier, and the Barrier needs authentication tokens to perform any actions as well.</li>
    </ul>
  </li>
  <li>Path: a prefix that tell the core where to route the secret to secret engines, auth methods, and audit devices.</li>
  <li>Mount: a path at which the secret engines, auth methods, and audit devices are mounted and receive requests</li>
  <li>System backend: is the default backend that is mounted at the /sys endpoint</li>
  <li>Each component has its default endpoint /, and it can be configured using the -path flag (expect the reserved pathes)</li>
  <li>Master Key:<ul>
      <li>is used to encrypt and decrypt the encryption key</li>
      <li>Generated during vault initialization or rekeying</li>
      <li>Never written to storage with the unseal mechanisms, but it is written under the core/master when using auto seal in the storage backend(encrypted)</li>
    </ul>
  </li>
  <li>Encryption Key:<ul>
      <li>Stored with the data in a keyring</li>
      <li>Can be rotated manually</li>
    </ul>
  </li>
</ul>
<blockquote>
  <ul>
    <li><strong>Keyring</strong>: A secure, in-memory collection of cryptographic keys used by Vault to encrypt and decrypt data.</li>
  </ul>
</blockquote>
<h3>Seal and Unseal states</h3>
<ul>
  <li>Vault starts in a sealed state: vault can reach the data but cannot decrypt it ( no operations are allowed at all),</li>
  <li>Unsealed state: vault nodes can reconstruct the master key to decrypt the encryption key, then decrypt the data, and the nodes stores the encryption key in their memory</li>
  <li>Sealing again: &nbsp;purge all the encryption keys in the memory</li>
  <li>Un/Sealing mechanisms:<ul>
      <li>Key Shards: Shamir's secret sharing algorithm, which breaks the master key to smaller fragments (shards ) so master key is not stored in one place(person). Reconstructing the master key requires at least three of these shards.<ul>
          <li>Default option</li>
          <li>the shards can be &nbsp;encrypted in different PGP keys</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>$ vault operator init -key-shares=3 -key-threshold=2</p>
  <p>$ vault operator unseal</p>
  <p>$ vault login &lt;Root_token&gt;</p>
</blockquote>
<ul>
  <li>Auto unseal: cloud services to protect the master key, AWS KMS,…., or on-prim HSM<ul>
      <li>the master key is stored in the storage backend encrypted by the cloud service or HSM</li>
      <li>in vault configuration file the type of auto unseal is configured &nbsp;&gt;&gt; seal “type”{} block</li>
      <li>Automatically unseal upon node restart or a service operation</li>
      <li>provide recovery keys for manual unsealing</li>
    </ul>
  </li>
</ul>
<blockquote>
  <p>$ vault operator unseal -migrate</p>
</blockquote>
<ul>
  <li>Transit Autounseal: protect the master key by another vault cluster<ul>
      <li>uses a transit secret of another vault cluster</li>
      <li>support key rotation</li>
      <li>the core vault must by highly available</li>
    </ul>
  </li>
</ul>
<figure class="table">
  <table>
    <tbody>
      <tr>
        <td><strong>Key Shards</strong></td>
        <td><strong>Auto unseal from a public cloud or HSM</strong></td>
        <td><strong>Transit Auto Unseal</strong></td>
      </tr>
      <tr>
        <td>Simplest from&nbsp;</td>
        <td>automatic</td>
        <td>automatic</td>
      </tr>
      <tr>
        <td>works on any platform</td>
        <td>Integration &nbsp;benefits with the cloud platforms</td>
        <td>Platform agnostic</td>
      </tr>
      <tr>
        <td>flexible</td>
        <td>cloud lock-in&nbsp;</td>
        <td>works on any platform</td>
      </tr>
      <tr>
        <td>Risk for keys exposure</td>
        <td>&nbsp;</td>
        <td>Require a centralized cluster</td>
      </tr>
      <tr>
        <td>manual intervention</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
      <tr>
        <td>manual rotation&nbsp;</td>
        <td>&nbsp;</td>
        <td>&nbsp;</td>
      </tr>
    </tbody>
  </table>
</figure>
<p>&nbsp;</p>
<h2>Vault Initialization</h2>
<ul>
  <li>Prepares the storage backend to receive data</li>
  <li>creates the master and encryption keys</li>
  <li>optionally, define numbers of key shards, threshold or recovery keys</li>
  <li>define the encryption with GPG keys</li>
  <li>generate the initial root token, cloud be encrypted by GPG keys</li>
</ul>
<blockquote>
  <p>$ vault operator init [options]</p>
</blockquote>
<h2>Vault conf file</h2>
<ul>
  <li>written on HCL or JSON in /etc/vauld.d/</li>
</ul>
<blockquote>
  <p>stanza1 “option” {</p>
  <p>&nbsp; private_ paramters = values</p>
  <p>}</p>
  <p>global_parameters = vaules</p>
</blockquote>
<blockquote>
  <p>$ vault server -config /path</p>
</blockquote>
<h3>sections</h3>
<ol>
  <li>Storage Backend | storage</li>
  <li>Listeners and Ports &gt; required to respond to all requests 0.0.0.0 | listener</li>
  <li>TLS certificates</li>
  <li>Seal type | seal</li>
  <li>Cluster name</li>
  <li>log level</li>
  <li>UI</li>
  <li>Cluster IP and Port</li>
  <li>others (telemetry).. &nbsp;| telemetry</li>
</ol>
<blockquote>
  <p>$ vault operator diagnose -config=/etc/vault.d/vault.hcl</p>
</blockquote>
<h2>Storage backend</h2>
<ul>
  <li>Location to save vault data</li>
  <li>Enterprise vault uses Consul(needs an agent on each vault node) or Integrated storage for HA (RAFT) and file system for non HA vault servers</li>
  <li>nodes of the cluster are primary/standby. One active at a time</li>
  <li>Replication happens at the vault APIs level not on the storage backend level between clusters, but it happens on the storage backend on the same cluster</li>
</ul>
<h2>Audit Devices</h2>
<ul>
  <li>Detailed JSON report of all authenticated requests and responses, with hashed sensitive data</li>
</ul>
<pre><code class="language-plaintext">$ vault audit enable 	file file_path=/path.log</code></pre>
<p>&nbsp;</p>
<ul>
  <li>Devices:<ol>
      <li>file: just appends logs to a file, required a solution for log rotation like fluented</li>
      <li>syslog: write logs to syslog, send data to local syslog agents</li>
      <li>sockets: UDP dependent</li>
    </ol>
  </li>
</ul>
<pre><code class="language-plaintext">	To complete a request vault must write the logs to at least one device, otherwise it does not send
	a response to the client, which essentially means that vault is down! So, it is recommended to 
	enable more than one audit device on each vault cluster.</code></pre>
<p>&nbsp;</p>
<p><a href="https://developer.hashicorp.com/vault/install">https://developer.hashicorp.com/vault/install</a></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
